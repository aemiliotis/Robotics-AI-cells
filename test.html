<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pi ToolForge</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; }
        .form-section { margin-bottom: 20px; }
    </style>
    <!-- Pi Authentication SDK (load from Pi Network CDN, replace with actual URL) -->
    <script src="https://sdk.pi.network/pi-sdk.js"></script>
</head>
<body>
    <div class="container">
        <h1>Pi ToolForge: Build Space Tools</h1>
        <div id="login-section" class="form-section">
            <h3>Login with Pi</h3>
            <button onclick="piLogin()" class="btn btn-primary">Login with Pi Network</button>
        </div>
        <div id="tool-form-section" class="form-section" style="display: none;">
            <h3>Create a Tool</h3>
            <form id="tool-form">
                <div class="mb-3">
                    <label for="tool-name" class="form-label">Tool Name</label>
                    <input type="text" id="tool-name" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label for="tool-type" class="form-label">Tool Type</label>
                    <select id="tool-type" class="form-select" required>
                        <option value="calculator">Calculator (e.g., Rocket Fuel Cost)</option>
                        <option value="visualizer">Visualizer (e.g., Satellite Orbit)</option>
                    </select>
                </div>
                <div id="inputs-section" class="mb-3">
                    <h4>Inputs</h4>
                    <div id="input-fields">
                        <div class="input-group mb-2">
                            <input type="text" class="form-control" placeholder="Input Label" name="input-label[]">
                            <input type="text" class="form-control" placeholder="Input Name" name="input-name[]">
                            <select class="form-select" name="input-type[]">
                                <option value="number">Number</option>
                                <option value="text">Text</option>
                            </select>
                            <button type="button" class="btn btn-danger" onclick="removeInput(this)">Remove</button>
                        </div>
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="addInput()">Add Input</button>
                </div>
                <button type="submit" class="btn btn-primary">Create Tool</button>
            </form>
        </div>
        <div id="result-section" class="form-section"></div>
    </div>

    <script>
        let userId = null;
        let accessToken = null;

        // Initialize Pi SDK
        window.Pi.init({ version: "2.0", appId: "your_pi_app_id" }); // Replace with your Pi App ID

        async function piLogin() {
            try {
                const authResult = await window.Pi.authenticate(['user_info']);
                userId = authResult.user.uid;
                accessToken = authResult.accessToken;
                
                // Send authentication to backend
                const response = await fetch('/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ access_token: accessToken })
                });
                const result = await response.json();
                if (result.status === 'success') {
                    document.getElementById('login-section').style.display = 'none';
                    document.getElementById('tool-form-section').style.display = 'block';
                } else {
                    alert('Pi Login failed: ' + result.message);
                }
            } catch (error) {
                alert('Pi Login error: ' + error.message);
            }
        }

        function addInput() {
            const inputFields = document.getElementById('input-fields');
            const newInput = document.createElement('div');
            newInput.className = 'input-group mb-2';
            newInput.innerHTML = `
                <input type="text" class="form-control" placeholder="Input Label" name="input-label[]">
                <input type="text" class="form-control" placeholder="Input Name" name="input-name[]">
                <select class="form-select" name="input-type[]">
                    <option value="number">Number</option>
                    <option value="text">Text</option>
                </select>
                <button type="button" class="btn btn-danger" onclick="removeInput(this)">Remove</button>
            `;
            inputFields.appendChild(newInput);
        }

        function removeInput(button) {
            button.parentElement.remove();
        }

        document.getElementById('tool-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const toolName = document.getElementById('tool-name').value;
            const toolType = document.getElementById('tool-type').value;
            const inputs = Array.from(document.getElementsByName('input-label[]')).map((label, i) => ({
                label: label.value,
                name: document.getElementsByName('input-name[]')[i].value,
                type: document.getElementsByName('input-type[]')[i].value
            }));
            const response = await fetch('/create_tool', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ access_token: accessToken, tool_name: toolName, tool_type: toolType, inputs, outputs: ['result'] })
            });
            const result = await response.json();
            if (result.status === 'success') {
                document.getElementById('result-section').innerHTML = `
                    <p>Tool created! Access it at: <a href="/tool/${result.tool_id}">${result.pinet_url}</a></p>
                `;
            } else {
                alert('Error: ' + result.message);
            }
        });
    </script>
</body>
</html>
