<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Worm Wars - Competitive Eating</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Arial', sans-serif;
        }
        
        body {
            background-color: #f0f0f0;
            color: #333;
            line-height: 1.6;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 20px;
            padding: 10px;
            background-color: #4CAF50;
            color: white;
            border-radius: 5px;
        }
        
        #auth-screen, #game-screen, #leaderboard {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        h1, h2, h3 {
            margin-bottom: 15px;
        }
        
        form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        input, button {
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
            font-size: 16px;
        }
        
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #45a049;
        }
        
        #game-container {
            position: relative;
            width: 100%;
            height: 500px;
            background-color: #e8f5e9;
            border: 2px solid #4CAF50;
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        .worm {
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            z-index: 10;
        }
        
        .worm-head {
            position: absolute;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            z-index: 20;
            border: 2px solid white;
        }
        
        .food {
            position: absolute;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            z-index: 5;
        }
        
        #controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .control-btn {
            width: 60px;
            height: 60px;
            font-size: 24px;
            display: none;
        }
        
        #score-display {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 10px;
            background-color: #e8f5e9;
            border-radius: 5px;
        }
        
        #leaderboard-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        #leaderboard-table th, #leaderboard-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        #leaderboard-table th {
            background-color: #4CAF50;
            color: white;
        }
        
        #leaderboard-table tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        
        .error-message {
            color: #f44336;
            margin-top: 5px;
            font-size: 14px;
        }
        
        @media (max-width: 768px) {
            #game-container {
                height: 400px;
            }
            
            .control-btn {
                display: block;
            }
            
            #controls {
                flex-wrap: wrap;
            }
            
            #up-btn, #down-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Worm Wars</h1>
            <p>Compete to eat the most food and grow your worm!</p>
        </header>
        
        <div id="auth-screen">
            <h2>Register or Login</h2>
            <div id="auth-tabs">
                <button id="show-register">Register</button>
                <button id="show-login">Login</button>
            </div>
            
            <form id="register-form" style="display: none;">
                <input type="text" id="reg-username" placeholder="Username" required>
                <input type="password" id="reg-password" placeholder="Password" required>
                <input type="password" id="reg-confirm" placeholder="Confirm Password" required>
                <button type="submit">Register</button>
                <div id="reg-error" class="error-message"></div>
            </form>
            
            <form id="login-form">
                <input type="text" id="login-username" placeholder="Username" required>
                <input type="password" id="login-password" placeholder="Password" required>
                <button type="submit">Login</button>
                <div id="login-error" class="error-message"></div>
            </form>
        </div>
        
        <div id="game-screen" style="display: none;">
            <h2>Welcome, <span id="player-name"></span>!</h2>
            <div id="score-display">
                <div>Your Score: <span id="player-score">0</span></div>
                <div>Leader: <span id="leader-score">-</span></div>
            </div>
            <div id="game-container"></div>
            <div id="controls">
                <button class="control-btn" id="up-btn">↑</button>
                <button class="control-btn" id="left-btn">←</button>
                <button class="control-btn" id="right-btn">→</button>
                <button class="control-btn" id="down-btn">↓</button>
            </div>
            <button id="logout-btn">Logout</button>
        </div>
        
        <div id="leaderboard">
            <h2>Leaderboard</h2>
            <table id="leaderboard-table">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Username</th>
                        <th>High Score</th>
                    </tr>
                </thead>
                <tbody id="leaderboard-body">
                    <!-- Leaderboard data will be inserted here -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Game state
        const gameState = {
            players: {},
            foods: [],
            currentPlayer: null,
            socket: null,
            direction: 'right',
            lastDirection: 'right',
            keysPressed: {},
            gameLoopInterval: null,
            playerId: null
        };

        // DOM elements
        const elements = {
            authScreen: document.getElementById('auth-screen'),
            gameScreen: document.getElementById('game-screen'),
            registerForm: document.getElementById('register-form'),
            loginForm: document.getElementById('login-form'),
            showRegister: document.getElementById('show-register'),
            showLogin: document.getElementById('show-login'),
            regError: document.getElementById('reg-error'),
            loginError: document.getElementById('login-error'),
            playerName: document.getElementById('player-name'),
            playerScore: document.getElementById('player-score'),
            leaderScore: document.getElementById('leader-score'),
            gameContainer: document.getElementById('game-container'),
            leaderboardBody: document.getElementById('leaderboard-body'),
            logoutBtn: document.getElementById('logout-btn'),
            upBtn: document.getElementById('up-btn'),
            downBtn: document.getElementById('down-btn'),
            leftBtn: document.getElementById('left-btn'),
            rightBtn: document.getElementById('right-btn')
        };

        // Simulated database
        const database = {
            users: JSON.parse(localStorage.getItem('worm-wars-users')) || {},
            leaderboard: JSON.parse(localStorage.getItem('worm-wars-leaderboard')) || []
        };

        // Auth tab switching
        elements.showRegister.addEventListener('click', () => {
            elements.registerForm.style.display = 'flex';
            elements.loginForm.style.display = 'none';
        });

        elements.showLogin.addEventListener('click', () => {
            elements.loginForm.style.display = 'flex';
            elements.registerForm.style.display = 'none';
        });

        // Registration
        elements.registerForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('reg-username').value;
            const password = document.getElementById('reg-password').value;
            const confirm = document.getElementById('reg-confirm').value;
            
            if (password !== confirm) {
                elements.regError.textContent = 'Passwords do not match';
                return;
            }
            
            if (database.users[username]) {
                elements.regError.textContent = 'Username already exists';
                return;
            }
            
            database.users[username] = { password, highScore: 0 };
            localStorage.setItem('worm-wars-users', JSON.stringify(database.users));
            elements.regError.textContent = '';
            alert('Registration successful! Please login.');
            elements.loginForm.style.display = 'flex';
            elements.registerForm.style.display = 'none';
            document.getElementById('login-username').value = username;
        });

        // Login
        elements.loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            
            if (!database.users[username]) {
                elements.loginError.textContent = 'Username not found';
                return;
            }
            
            if (database.users[username].password !== password) {
                elements.loginError.textContent = 'Incorrect password';
                return;
            }
            
            elements.loginError.textContent = '';
            loginUser(username);
        });

        // Logout
        elements.logoutBtn.addEventListener('click', () => {
            logoutUser();
        });

        // Mobile controls
        elements.upBtn.addEventListener('click', () => changeDirection('up'));
        elements.downBtn.addEventListener('click', () => changeDirection('down'));
        elements.leftBtn.addEventListener('click', () => changeDirection('left'));
        elements.rightBtn.addEventListener('click', () => changeDirection('right'));

        // Keyboard controls
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowUp') changeDirection('up');
            else if (e.key === 'ArrowDown') changeDirection('down');
            else if (e.key === 'ArrowLeft') changeDirection('left');
            else if (e.key === 'ArrowRight') changeDirection('right');
        });

        function changeDirection(newDirection) {
            // Prevent reversing direction
            if (
                (gameState.direction === 'up' && newDirection === 'down') ||
                (gameState.direction === 'down' && newDirection === 'up') ||
                (gameState.direction === 'left' && newDirection === 'right') ||
                (gameState.direction === 'right' && newDirection === 'left')
            ) {
                return;
            }
            
            gameState.direction = newDirection;
        }

        function loginUser(username) {
            gameState.currentPlayer = username;
            elements.playerName.textContent = username;
            elements.authScreen.style.display = 'none';
            elements.gameScreen.style.display = 'block';
            
            // Initialize game
            initGame();
            
            // Connect to "server" (simulated with localStorage)
            connectToServer();
        }

        function logoutUser() {
            gameState.currentPlayer = null;
            elements.authScreen.style.display = 'block';
            elements.gameScreen.style.display = 'none';
            
            // Clear game state
            clearInterval(gameState.gameLoopInterval);
            gameContainer.innerHTML = '';
        }

        function connectToServer() {
            // Simulate WebSocket with localStorage and polling
            gameState.socket = {
                send: (data) => {
                    // In a real app, this would send data to the server
                    // Here we'll just process it locally
                    processServerMessage({ data: JSON.stringify(data) });
                }
            };
            
            // Start polling for updates
            setInterval(() => {
                const updates = JSON.parse(localStorage.getItem('worm-wars-updates') || '[]');
                if (updates.length > 0) {
                    updates.forEach(processServerMessage);
                    localStorage.setItem('worm-wars-updates', JSON.stringify([]));
                }
            }, 100);
            
            // Send join message
            gameState.socket.send({
                type: 'join',
                username: gameState.currentPlayer
            });
        }

        function processServerMessage(message) {
            const data = JSON.parse(message.data);
            
            switch (data.type) {
                case 'init':
                    gameState.playerId = data.playerId;
                    gameState.players = data.players;
                    gameState.foods = data.foods;
                    renderGame();
                    startGameLoop();
                    updateLeaderboard();
                    break;
                    
                case 'update':
                    gameState.players = data.players;
                    gameState.foods = data.foods;
                    updateLeaderScore();
                    break;
                    
                case 'leaderboard':
                    updateLeaderboard(data.leaderboard);
                    break;
            }
        }

        function initGame() {
            // Generate random player ID
            gameState.playerId = 'player-' + Math.random().toString(36).substr(2, 9);
            
            // Initialize player
            gameState.players[gameState.playerId] = {
                username: gameState.currentPlayer,
                segments: [
                    { x: 200, y: 200 },
                    { x: 180, y: 200 },
                    { x: 160, y: 200 }
                ],
                direction: 'right',
                score: 0,
                color: getRandomColor()
            };
            
            // Generate initial food
            generateFood(10);
            
            // Start game loop
            startGameLoop();
        }

        function startGameLoop() {
            if (gameState.gameLoopInterval) {
                clearInterval(gameState.gameLoopInterval);
            }
            
            gameState.gameLoopInterval = setInterval(() => {
                updateGame();
                renderGame();
                
                // Send update to "server"
                if (gameState.socket) {
                    gameState.socket.send({
                        type: 'move',
                        playerId: gameState.playerId,
                        direction: gameState.direction,
                        segments: gameState.players[gameState.playerId].segments,
                        score: gameState.players[gameState.playerId].score
                    });
                }
            }, 100);
        }

        function updateGame() {
            const player = gameState.players[gameState.playerId];
            if (!player) return;
            
            // Move the worm
            const head = { ...player.segments[0] };
            
            switch (gameState.direction) {
                case 'up':
                    head.y -= 20;
                    break;
                case 'down':
                    head.y += 20;
                    break;
                case 'left':
                    head.x -= 20;
                    break;
                case 'right':
                    head.x += 20;
                    break;
            }
            
            // Check boundaries (wrap around)
            const gameWidth = elements.gameContainer.clientWidth;
            const gameHeight = elements.gameContainer.clientHeight;
            
            if (head.x < 0) head.x = gameWidth - 20;
            if (head.x >= gameWidth) head.x = 0;
            if (head.y < 0) head.y = gameHeight - 20;
            if (head.y >= gameHeight) head.y = 0;
            
            // Check for collisions with food
            let ateFood = false;
            gameState.foods = gameState.foods.filter(food => {
                const distance = Math.sqrt(Math.pow(food.x - head.x, 2) + Math.pow(food.y - head.y, 2));
                if (distance < 18) {
                    ateFood = true;
                    player.score += 10;
                    elements.playerScore.textContent = player.score;
                    return false;
                }
                return true;
            });
            
            // Add new head
            player.segments.unshift(head);
            
            // If didn't eat food, remove tail
            if (!ateFood) {
                player.segments.pop();
            } else {
                // Generate new food
                generateFood(1);
                
                // Update high score if needed
                if (player.score > database.users[gameState.currentPlayer].highScore) {
                    database.users[gameState.currentPlayer].highScore = player.score;
                    localStorage.setItem('worm-wars-users', JSON.stringify(database.users));
                    updateLeaderboard();
                }
            }
            
            // Check for collisions with self
            for (let i = 4; i < player.segments.length; i++) {
                if (player.segments[i].x === head.x && player.segments[i].y === head.y) {
                    // Game over
                    resetPlayer();
                    break;
                }
            }
        }

        function resetPlayer() {
            const player = gameState.players[gameState.playerId];
            player.segments = [
                { x: 200, y: 200 },
                { x: 180, y: 200 },
                { x: 160, y: 200 }
            ];
            player.direction = 'right';
            gameState.direction = 'right';
            player.score = 0;
            elements.playerScore.textContent = '0';
        }

        function generateFood(count) {
            const gameWidth = elements.gameContainer.clientWidth;
            const gameHeight = elements.gameContainer.clientHeight;
            
            for (let i = 0; i < count; i++) {
                gameState.foods.push({
                    x: Math.floor(Math.random() * (gameWidth / 20)) * 20,
                    y: Math.floor(Math.random() * (gameHeight / 20)) * 20,
                    color: getRandomColor()
                });
            }
        }

        function renderGame() {
            // Clear the game container
            elements.gameContainer.innerHTML = '';
            
            // Render food
            gameState.foods.forEach(food => {
                const foodElement = document.createElement('div');
                foodElement.className = 'food';
                foodElement.style.left = `${food.x}px`;
                foodElement.style.top = `${food.y}px`;
                foodElement.style.backgroundColor = food.color;
                elements.gameContainer.appendChild(foodElement);
            });
            
            // Render players
            Object.keys(gameState.players).forEach(playerId => {
                const player = gameState.players[playerId];
                
                // Render segments
                player.segments.forEach((segment, index) => {
                    const segmentElement = document.createElement('div');
                    segmentElement.className = index === 0 ? 'worm-head' : 'worm';
                    segmentElement.style.left = `${segment.x}px`;
                    segmentElement.style.top = `${segment.y}px`;
                    segmentElement.style.backgroundColor = player.color;
                    
                    if (index === 0) {
                        // Add player name above head
                        const nameTag = document.createElement('div');
                        nameTag.textContent = player.username;
                        nameTag.style.position = 'absolute';
                        nameTag.style.left = `${segment.x}px`;
                        nameTag.style.top = `${segment.y - 25}px`;
                        nameTag.style.color = player.color;
                        nameTag.style.fontWeight = 'bold';
                        nameTag.style.textShadow = '1px 1px 1px black';
                        nameTag.style.whiteSpace = 'nowrap';
                        elements.gameContainer.appendChild(nameTag);
                    }
                    
                    elements.gameContainer.appendChild(segmentElement);
                });
            });
        }

        function updateLeaderScore() {
            let maxScore = 0;
            Object.values(gameState.players).forEach(player => {
                if (player.score > maxScore) {
                    maxScore = player.score;
                }
            });
            elements.leaderScore.textContent = maxScore;
        }

        function updateLeaderboard() {
            // Get all users with their high scores
            const leaderboard = [];
            for (const username in database.users) {
                leaderboard.push({
                    username,
                    highScore: database.users[username].highScore
                });
            }
            
            // Sort by score (descending)
            leaderboard.sort((a, b) => b.highScore - a.highScore);
            
            // Update the table
            elements.leaderboardBody.innerHTML = '';
            leaderboard.slice(0, 10).forEach((user, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${user.username}</td>
                    <td>${user.highScore}</td>
                `;
                elements.leaderboardBody.appendChild(row);
            });
        }

        function getRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        // Initialize leaderboard
        updateLeaderboard();
    </script>
</body>
</html>
